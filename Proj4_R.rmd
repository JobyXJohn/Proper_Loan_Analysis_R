---
output:
  pdf_document:
    fig_caption: yes
    fig_height: 10
    fig_width: 16
    highlight: tango
    keep_tex: yes
    toc: yes
  html_document:
    toc: yes
  word_document: default
---
---
title: 'Project 4: Prosper Loan Data'
author: "Joby John"
date: "November 10, 2015"
output: md_document
header-includes:
   - \usepackage{amsmath}
fontsize: 10pt
---
## Introduction

This dataset involves the loan data from Prosper Loans. The aim is conduct an Exploratory Data Analysis (EDA) of this dataset and find hidden relationships and important features that affect the lender and the borrower. Going through the description of the features one can get a good idea of the lender-borrower relationship. The lender wants to maximize his returns or yield from the Borrower and the latter wants to ideally pay off the debt without accruing too much interest and service fees. However due to various constraints the borrower has to agree to terms which are not in his best interest or even default on the payments thus affecting his credit scores and his future credit worthiness.

From a lender's perspective, he is looking to understand the risk vs benefit in lending to a certain borrower and thus looks at all factors that point to his credit worthiness. From a borrower's perspective one can understand factors that affect one's ability to pay back the loan in a timely manner without overpaying by analyzing the relationship between various variables. Going through the description of some of the variables we can identify some of the variables that are of interest to us. The variables of interest are marked below with an asterisk.

### Initialize Global Options 
```{r set-options, cache=FALSE}
library(knitr)
options(width = 80)
opts_chunk$set(tidy.opts = list(width.cutoff = 80))
opts_chunk$set(
comment = "", warning = FALSE, message = FALSE, echo = TRUE, tidy = FALSE,size =
"small"
)
hook_output = knit_hooks$get('output')
knit_hooks$set( output = function(x, options)
{
  # this hook is used only when the linewidth option is not NULL
  if (!is.null(n <- options$linewidth)) 
  {x = knitr:::split_lines(x)
  # any lines wider than n should be wrapped
  if (any(nchar(x) > n))
    x = strwrap(x, width = n)
  x = paste(x, collapse = '\n')
  }
  hook_output(x, options)})

```

## Load the Data and Libraries
```{r Data_Libraries}
pd <- read.csv('prosperLoanData.csv')
library(reshape2)
library(RColorBrewer)
library(ggplot2)
library(extrafont) # For CM Roman fonts on figure labels.
library(GGally)
str(pd) # Structure of the dataframe
ntheme = theme_grey()+theme(text = element_text(family = "CMU Serif",size = 24))
theme_set(ntheme)
```
### Matrix Of Plots
We make a couple of preliminary matrix plots to get a feel for the data. It would be nice to edit the variable names in the ggpairs command for easy readability. It was easier to just create another dataframe and rename the variables to a smaller name as a easy fix.
```{r MatrixPfPlots}
library(plyr)
fd <- rename(
pd, c(
'CreditGrade' = 'CGrade', 'LoanStatus' = 'LStatus',
'BorrowerAPR' = 'bApr', 'LenderYield' = 'LYield',
'EstimatedEffectiveYield = EEYield', 'EstimatedLoss' = 'ELoss',
'EstimatedReturn' = 'EReturn', 'ProsperRating..numeric.' = 'Rating',
'ProsperScore' = 'PScore','BorrowerState' = 'BState','Occupation' =
'Occup',
'EmploymentStatus' = 'Estatus','CreditScoreRangeLower' = 'CSLow',
'CreditScoreRangeUpper' = 'CSUp','CurrentCreditLines' = 'CCLine',
'OpenCreditLines' = 'OCLine','TotalCreditLinespast7years' = 'TC7yrs',
'OpenRevolvingMonthlyPayment' = 'ORMpay', 'CurrentDelinquencies' = 'CrntDel',
'AmountDelinquent' = 'AmDel','DelinquenciesLast7Years' = 'Del7yrs',
'DebtToIncomeRatio' = 'D2IRat', 'LoanMonthsSinceOrigination' = 'LMnthOri',
'MonthlyLoanPayment' = 'MLPay',
'LP_CustomerPayments' = 'CusPay','LP_CustomerPrincipalPayments' = 'CusPPay',
'LP_GrossPrincipalLoss' = 'GrPrLs','LP_NetPrincipalLoss' = 'NtPrLs'
)
)
# matrix of plots
set.seed(10000)
pdn <- fd[sample(1:length(pd$LenderYield),10000),c(4,8,10,14,16,17,18,21,29,30,31,32,
                                                  33,37,38)]
p1 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))

suppressMessages(print(p1))

pdn = fd[sample(1:length(pd$LenderYield),10000),c(38,39,47,48,50,54,57,58,60,62,68,69,
                                                  70,75)]
p2 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))
suppressMessages(print(p2))

pdn  = fd[sample(1:length(pd$LenderYield),10000),c(48,58,60,62,68,69,70,75)]
p3 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))
suppressMessages(print(p3))

pdn = fd[sample(1:length(pd$LenderYield),10000),c(4,8,11,12,14,16,20)]
p4 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))  
suppressMessages(print(p4))

pdn = fd[sample(1:length(pd$LenderYield),10000),c(4,8,11,12,14,16,20,31, 38,58,62,75)]
p5 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))
suppressMessages(print(p5))

```
## Factor Variables
We see that some of the variables that should be factors are treated as numeric variables by noticing that we get a density plot instead of a histogram (e.g. ProsperRating..numeric.). Accordingly, we convert them to factor variables:
```{r ConvertToFactors}
# Prosperrating as a factor
pd$ProsperRating..numeric. = as.factor(pd$ProsperRating..numeric.)
# Loan TermPeriod as a factor
pd$Term = as.factor(pd$Term)
# Order the Grades in decreasing order
pd$CreditGrade = ordered(pd$CreditGrade,c("AA", "A","B", "C", "D", "E", "HR","NC",""))
# Order the ProsperScore
unique(pd$ProsperScore)
pd$ProsperScore = ordered(pd$ProsperScore,c(1,2,3,4,5,6,7,8,9,10,11,NA))
```
## Exploratory Analysis
```{r AmountDelinquent}
pds <-
  subset(pd,LoanCurrentDaysDelinquent > 0) # subset of delinquent loans
  qplot(
  data = pd,x = pd$LoanCurrentDaysDelinquent,binwidth = 50
  ) +
  scale_x_continuous(breaks = seq(0,3000,200),limits = c(1,3000)) +
  xlab('Days Delinquent')
# Notice some people who are delinquent for more than 2500 days!!
# The number of people who remain delinquent drops after 1000 days. It further incrases
#to 2000 days and just before 2500 days there is an abrupt drop in the number of
#delinquent loans indicating that the loans were probably charged off after that limit.
#There are a few "extraodrindary" loans that survive the 2500 day mark.
```

Consider the variation of delinquent amount and the number of delinquencies the borrower has had in the last 7 years. 
```{r AmopuntDelinquent_vs_DaysDelinquent}
    npd <- pd[pd$AmountDelinquent > 0 & !is.na(pd$AmountDelinquent &
                                               pd$LoanCurrentDaysDelinquent > 0.1),]
    npd <- npd[npd$LoanCurrentDaysDelinquent > 0,]
    ggplot(data = npd,aes(x = LoanCurrentDaysDelinquent,y = AmountDelinquent)) +
    geom_point( size = 1,position = 'jitter',alpha = 1,color = 'red') +
    geom_line(linetype = 1,stat = "summary",fun.y = median) +
    xlab('Current Days Delinquent') +
    ylab('AmountDelinquent') + ylim(c(0,1.5e5))
    geom_smooth(method = "lm")
    # It is hard to see any relation between the variables.
```
Looking at the same variables in log-scale reveals a hidden relationship.
```{r AmountDelinquent_vs_DelinquenciesInLast7Years}
npd <- pd[pd$AmountDelinquent>0 & !is.na(pd$AmountDelinquent 
                                         & pd$DelinquenciesLast7Years>0.1),]
npd <- npd[npd$DelinquenciesLast7Years>0,]
pamtDelinq <- ggplot(data=npd,aes(x=DelinquenciesLast7Years,y=AmountDelinquent))+
  geom_point(size=1,position = 'jitter',alpha=1/5,color='red')+
  geom_line(stat='summary',fun.y=quantile,probs=0.9,linetype=2,color='blue')+
  geom_line(linetype=1,stat="summary",fun.y=median)+
  geom_line(stat='summary',fun.y=quantile,probs=0.1,linetype=2,color='blue')+
  scale_x_log10()+scale_y_log10()+
  stat_smooth(formula = y~x)+
  xlab('Log of Delinquencies in Last 7 years')+ylab('Log of AmountDelinquent')
print(pamtDelinq)
# 
```
We see that there is a relationship of the form $y=k x^m$, where y = mean of  AmountDelinqeint and $x$= mean of Current Days Delinquent.


