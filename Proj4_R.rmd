---
output:
  pdf_document:
    fig_caption: yes
    fig_height: 10
    fig_width: 16
    highlight: tango
    keep_tex: yes
    toc: yes
  html_document:
    toc: yes
  word_document: default
---
---
title: 'Project 4: Prosper Loan Data'
author: "Joby John"
date: "November 10, 2015"
output: md_document
header-includes:
   - \usepackage{amsmath}
fontsize: 10pt
---
## Introduction

This dataset involves the loan data from Prosper Loans. The aim is conduct an Exploratory Data Analysis (EDA) of this dataset and find hidden relationships and important features that affect the lender and the borrower. Going through the description of the features one can get a good idea of the lender-borrower relationship. The lender wants to maximize his returns or yield from the Borrower and the latter wants to ideally pay off the debt without accruing too much interest and service fees. However due to various constraints the borrower has to agree to terms which are not in his best interest or even default on the payments thus affecting his credit scores and his future credit worthiness.

From a lender's perspective, he is looking to understand the risk vs benefit in lending to a certain borrower and thus looks at all factors that point to his credit worthiness. From a borrower's perspective one can understand factors that affect one's ability to pay back the loan in a timely manner without overpaying by analyzing the relationship between various variables. Going through the description of some of the variables we can identify some of the variables that are of interest to us. The variables of interest are marked below with an asterisk.

### Initialize Global Options 
```{r set-options, cache=FALSE}
library(knitr)
options(width = 80)
opts_chunk$set(tidy.opts = list(width.cutoff = 80))
opts_chunk$set(
comment = "", warning = FALSE, message = FALSE, echo = TRUE, tidy = FALSE,size =
"small"
)
hook_output = knit_hooks$get('output')
knit_hooks$set( output = function(x, options)
{
  # this hook is used only when the linewidth option is not NULL
  if (!is.null(n <- options$linewidth)) 
  {x = knitr:::split_lines(x)
  # any lines wider than n should be wrapped
  if (any(nchar(x) > n))
    x = strwrap(x, width = n)
  x = paste(x, collapse = '\n')
  }
  hook_output(x, options)})

```

## Load the Data and Libraries
```{r Data_Libraries}
pd <- read.csv('prosperLoanData.csv')
library(reshape2)
library(RColorBrewer)
library(ggplot2)
library(extrafont) # For CM Roman fonts on figure labels.
library(GGally)
str(pd) # Structure of the dataframe
ntheme = theme_grey()+theme(text = element_text(family = "CMU Serif",size = 24))
theme_set(ntheme)
```
### Matrix Of Plots
We make a couple of preliminary matrix plots to get a feel for the data. It would be nice to edit the variable names in the ggpairs command for easy readability. It was easier to just create another dataframe and rename the variables to a smaller name as a easy fix.
```{r MatrixPfPlots}
library(plyr)
fd <- rename(
pd, c(
'CreditGrade' = 'CGrade', 'LoanStatus' = 'LStatus',
'BorrowerAPR' = 'bApr', 'LenderYield' = 'LYield',
'EstimatedEffectiveYield = EEYield', 'EstimatedLoss' = 'ELoss',
'EstimatedReturn' = 'EReturn', 'ProsperRating..numeric.' = 'Rating',
'ProsperScore' = 'PScore','BorrowerState' = 'BState','Occupation' =
'Occup',
'EmploymentStatus' = 'Estatus','CreditScoreRangeLower' = 'CSLow',
'CreditScoreRangeUpper' = 'CSUp','CurrentCreditLines' = 'CCLine',
'OpenCreditLines' = 'OCLine','TotalCreditLinespast7years' = 'TC7yrs',
'OpenRevolvingMonthlyPayment' = 'ORMpay', 'CurrentDelinquencies' = 'CrntDel',
'AmountDelinquent' = 'AmDel','DelinquenciesLast7Years' = 'Del7yrs',
'DebtToIncomeRatio' = 'D2IRat', 'LoanMonthsSinceOrigination' = 'LMnthOri',
'MonthlyLoanPayment' = 'MLPay',
'LP_CustomerPayments' = 'CusPay','LP_CustomerPrincipalPayments' = 'CusPPay',
'LP_GrossPrincipalLoss' = 'GrPrLs','LP_NetPrincipalLoss' = 'NtPrLs'
)
)
# matrix of plots
set.seed(10000)
pdn <- fd[sample(1:length(pd$LenderYield),10000),c(4,8,10,14,16,17,18,21,29,30,31,32,
                                                  33,37,38)]
p1 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))

suppressMessages(print(p1))

pdn = fd[sample(1:length(pd$LenderYield),10000),c(38,39,47,48,50,54,57,58,60,62,68,69,
                                                  70,75)]
p2 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))
suppressMessages(print(p2))

pdn  = fd[sample(1:length(pd$LenderYield),10000),c(48,58,60,62,68,69,70,75)]
p3 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))
suppressMessages(print(p3))

pdn = fd[sample(1:length(pd$LenderYield),10000),c(4,8,11,12,14,16,20)]
p4 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))  
suppressMessages(print(p4))

pdn = fd[sample(1:length(pd$LenderYield),10000),c(4,8,11,12,14,16,20,31, 38,58,62,75)]
p5 <- ggpairs(pdn,params = c(shape = I('.'),outlier.shape = I('.')))
suppressMessages(print(p5))

```
## Factor Variables
We see that some of the variables that should be factors are treated as numeric variables by noticing that we get a density plot instead of a histogram (e.g. ProsperRating..numeric.). Accordingly, we convert them to factor variables:
```{r ConvertToFactors}
# Prosperrating as a factor
pd$ProsperRating..numeric. = as.factor(pd$ProsperRating..numeric.)
# Loan TermPeriod as a factor
pd$Term = as.factor(pd$Term)
# Order the Grades in decreasing order
pd$CreditGrade = ordered(pd$CreditGrade,c("AA", "A","B", "C", "D", "E", "HR","NC",""))
# Order the ProsperScore
unique(pd$ProsperScore)
pd$ProsperScore = ordered(pd$ProsperScore,c(1,2,3,4,5,6,7,8,9,10,11,NA))
```
## Exploratory Analysis
```{r AmountDelinquent}
pds <-
  subset(pd,LoanCurrentDaysDelinquent > 0) # subset of delinquent loans
  qplot(
  data = pd,x = pd$LoanCurrentDaysDelinquent,binwidth = 50
  ) +
  scale_x_continuous(breaks = seq(0,3000,200),limits = c(1,3000)) +
  xlab('Days Delinquent')
# Notice some people who are delinquent for more than 2500 days!!
# The number of people who remain delinquent drops after 1000 days. It further incrases
#to 2000 days and just before 2500 days there is an abrupt drop in the number of
#delinquent loans indicating that the loans were probably charged off after that limit.
#There are a few "extraodrindary" loans that survive the 2500 day mark.
```

Consider the variation of delinquent amount and the number of delinquencies the borrower has had in the last 7 years. 
```{r AmopuntDelinquent_vs_DaysDelinquent}
    npd <- pd[pd$AmountDelinquent > 0 & !is.na(pd$AmountDelinquent &
                                               pd$LoanCurrentDaysDelinquent > 0.1),]
    npd <- npd[npd$LoanCurrentDaysDelinquent > 0,]
    ggplot(data = npd,aes(x = LoanCurrentDaysDelinquent,y = AmountDelinquent)) +
    geom_point( size = 1,position = 'jitter',alpha = 1,color = 'red') +
    geom_line(linetype = 1,stat = "summary",fun.y = median) +
    xlab('Current Days Delinquent') +
    ylab('AmountDelinquent') + ylim(c(0,1.5e5))
    geom_smooth(method = "lm")
    # It is hard to see any relation between the variables.
```
Looking at the same variables in log-scale reveals a hidden relationship.
```{r AmountDelinquent_vs_DelinquenciesInLast7Years}
npd <- pd[pd$AmountDelinquent>0 & !is.na(pd$AmountDelinquent 
                                         & pd$DelinquenciesLast7Years>0.1),]
npd <- npd[npd$DelinquenciesLast7Years>0,]
pamtDelinq <- ggplot(data=npd,aes(x=DelinquenciesLast7Years,y=AmountDelinquent))+
  geom_point(size=1,position = 'jitter',alpha=1/5,color='red')+
  geom_line(stat='summary',fun.y=quantile,probs=0.9,linetype=2,color='blue')+
  geom_line(linetype=1,stat="summary",fun.y=median)+
  geom_line(stat='summary',fun.y=quantile,probs=0.1,linetype=2,color='blue')+
  scale_x_log10()+scale_y_log10()+
  stat_smooth(formula = y~x)+
  xlab('Log of Delinquencies in Last 7 years')+ylab('Log of AmountDelinquent')
print(pamtDelinq)
# 
```
We see that there is a relationship of the form $y=k x^m$, where y = mean of  AmountDelinqeint and $x$= mean of Current Days Delinquent.

Plot By Credit Grade
Reorder the credit grades in the right order.
```{r CreditGrade}
# Reorder the grades
pd$CreditGrade= ordered(pd$CreditGrade,c("AA", "A","B", "C", "D", "E", "HR","NC",""))
pd$ProsperRating..Alpha.= ordered(pd$ProsperRating..Alpha.,c("AA", "A","B", "C", "D", "E", "HR","",NA))
library(plyr)
pd$CreditGrade = mapvalues(pd$CreditGrade, from = "", to = "NV")
pd$pd$ProsperRating..Alpha. = mapvalues(pd$ProsperRating..Alpha., from = "", to = "NV")
# NV for "No Value""

# plot of CreditGrade vs Amount Delinquent.
ggplot(aes(x=CreditGrade,y=AmountDelinquent),data=pd[pd$AmountDelinquent>0,])+
  geom_boxplot()+ylim(c(0,2.5e3))

ggplot(aes(x=ProsperRating..Alpha.,y=AmountDelinquent),data=pd[pd$AmountDelinquent>0,])+
  geom_boxplot()+ylim(c(0,2.5e3))+
  guides(color=guide_legend(title="Rating", override.aes =
                                           list(size=5)))

qplot(x=pds$LP_CustomerPrincipalPayments/pds$LoanOriginalAmount,
      y=pds$AmountDelinquent/pds$LoanOriginalAmount,data=pds,color=ProsperScore)+
  scale_y_log10()+xlim(0,0.5)
# Comparing the Borrower APR and Prosper Rating
ggplot(aes(x=ProsperRating..numeric.,y=BorrowerAPR),
       data=pd[!is.na(pd$ProsperRating..numeric.),])+
  geom_boxplot()+scale_x_discrete()+xlab("Prosper Rating")
# This figure shows that as a lender's rating worsens, the lender tries to mitigate his
# risk by levying a heavier interesrt rate on the loan. For future borrowers, just this
# plot should be incentive to maintain a high credit rating.  
```

### By State
```{r ByState}
#pds<-subset(pd,AmountDelinquent>0) # subset of delinquent loans
pds <- pd[pd$AmountDelinquent>0 & !is.na(pd$LoanOriginalAmount) & !is.na(pd$LoanOriginalAmount)>0,]
#pds$NormalizeAmtDelinq=pds$AmountDelinquent/pds$LoanOriginalAmount
ggplot(aes(x=BorrowerState,y=AmountDelinquent/LoanOriginalAmount),data=pds)+
  geom_boxplot()+ylab('Delinquent Amount / Original Loan')+
  xlab('Borrower State')+
  theme(axis.text.x =element_text(angle=0,size=10))+coord_cartesian(ylim=c(0,2.5))
#### check log vs non-log
ggplot(aes(x=BorrowerState,y=AmountDelinquent/LoanOriginalAmount),data=pds)+
  geom_boxplot()+scale_y_log10()+ylab('Delinquent Amount / Original Loan')+
  xlab('Borrower State')+
  theme(axis.text.x =element_text(angle=0,size=10))
```


```{r Ratio}
library(dplyr)
pdAmtDelinqRatio<- pd[pd$AmountDelinquent>0 & !is.na(pd$AmountDelinquent),] %>%
                         group_by(BorrowerState) %>%
                         dplyr::summarise(mean_AmtDelinqRatio= mean(AmountDelinquent/LoanOriginalAmount),
                         n=n()) %>%
                         arrange(BorrowerState)
pdAmtDelinqRatio[pdAmtDelinqRatio$n== max(pdAmtDelinqRatio$n),]
pdAmtDelinqRatio[pdAmtDelinqRatio$n== min(pdAmtDelinqRatio$n),]
```
```{r AmtDelinq}
pdAmtDelinqByState <- pd[pd$AmountDelinquent>0 & !is.na(pd$AmountDelinquent),] %>%
                         group_by(BorrowerState) %>%
                         dplyr::summarise(mean_Amount_Delinq = mean(AmountDelinquent),
                         n=n()) %>%
                         arrange(BorrowerState)
summary(pdAmtDelinqByState)
ggplot(aes(x=BorrowerState,y=mean_Amount_Delinq),data=pdAmtDelinqByState)+geom_bar(stat="identity")+theme(axis.text.x =element_text(angle=0,size=10))+ylab('Mean Amount Delinquent')
# Sometimes the Amount Delinquent is 2 orders of magnitude greater than Original Loan. 
```
```{r}
##Minimum and Max Absolute Delinquencies 
pdAmtDelinqByState[pdAmtDelinqByState$n== max(pdAmtDelinqByState$n),]
pdAmtDelinqByState[pdAmtDelinqByState$n== min(pdAmtDelinqByState$n),]
```


### Yield, Returns, and Other Plots
```{r}
### We could do similar analysis for Yield by Credit Rating. 
before2009 = pd[as.POSIXct(pd$LoanOriginationDate) < as.POSIXct('2009-01-01 00:00:00'),
                'CreditGrade']
after2009 = pd[as.POSIXct(pd$LoanOriginationDate) >=as.POSIXct('2009-01-01 00:00:00'),
               'ProsperRating..Alpha.']
```
```{r}
pd[as.POSIXct(pd$LoanOriginationDate) < as.POSIXct('2009-01-01 00:00:00'),
   'ConsolCreditGrade'] <- before2009
pd[as.POSIXct(pd$LoanOriginationDate) >= as.POSIXct('2009-01-01 00:00:00'),
   'ConsolCreditGrade'] <- after2009
```
```{r}
pd$ConsolCreditGrade= ordered(pd$ConsolCreditGrade,levels=c("AA", "A","B", "C", "D", "E", "HR","NC","NV",NA))

spd <- pd[!is.na(pd$EstimatedLoss) & !is.na(pd$EstimatedEffectiveYield),]
pdLossYield <-  pd %>%
                group_by(ConsolCreditGrade) %>%
                summarize(mean_Estimated_Loss = mean(EstimatedLoss,na.rm=TRUE),
                mean_Effective_Yield = mean(EstimatedEffectiveYield,na.rm=TRUE)) %>%
                ungroup()%>%
                arrange(ConsolCreditGrade)
```

```{r}
qplot(x=ConsolCreditGrade,y=mean_Estimated_Loss,data=pdLossYield)+
  geom_bar(stat="identity")+xlab('Credit Grade')+ylab('Estimated Loss (Mean)')

qplot(x=ConsolCreditGrade,y=mean_Effective_Yield,data=pdLossYield)+
  geom_bar(stat="identity")+xlab('Credit Grade')+ylab('Effective Yield (Mean)')
```
Similarly we can ask questions like which kind of Loan is made out most. Or which state has the most number of motorcycle loans.

## By State
```{r MoreSummary}
# Statewise count of the number of loans in each category.
pdQ <-  pd %>%
                group_by(BorrowerState,ListingCategory..numeric.) %>%
                summarize(count = n(),
                          Amount = sum(LoanOriginalAmount)) %>%
                arrange(BorrowerState)
pdQmost <- pdQ[!(pdQ$BorrowerState==""),] %>%
          group_by(ListingCategory..numeric.) %>%
          summarize(TotalNumber = sum(count),
                    TotalLoan = sum(Amount))%>%
          arrange(TotalNumber)
qplot(data=pdQmost,x=ListingCategory..numeric.,y=TotalNumber)+geom_bar(stat="identity")+
  scale_y_log10()+xlab('Category')+ylab('Number Of Loans')

qplot(data=pdQmost,x=ListingCategory..numeric.,y=TotalLoan)+
  geom_bar(stat="identity")+scale_y_log10()+xlab('Category')+ylab('Loan Amounts')
```

All the dplyr based analysis comes here

### Service fee
The difference between the \emph{Lender Yield} and the \emph{Borrower rate} is the service fee. Plotting the histogram of the difference between the two quantities we find that mostly the service fee is about $.01\%$. 

```{r} 
pd$SerFee = pd$BorrowerRate-pd$LenderYield
ggplot(data=pd)+geom_histogram(aes(x=SerFee),binwidth=0.001)
```

## Loan Status and Loan Term
```{r LoanStatus}
#Check if the Effective Yield is affected by the loan status
ggplot(aes(x = LoanStatus,y = EstimatedEffectiveYield),data = pd) + geom_boxplot() +
  theme(axis.text.x =  element_text(angle = 45,size = 20))
# Reorder the factor LoanStatus.
pd$LoanStatus = ordered(pd$LoanStatus,c("Completed","Current","FinalPaymentInProgress","Past Due (1-15 days)","Past Due (16-30 days)", "Past Due (31-60 days)", "Past Due (61-90 days)", "Past Due (91-120 days)", "Past Due (>120 days)","Defaulted","Chargedoff","Cancelled"))  
# Replot the above plot with reordered Status
ggplot(aes(x = LoanStatus,y = EstimatedEffectiveYield),data = pd) + geom_boxplot() +
  theme(axis.text.x =  element_text(angle = 45,size = 20))
# How does Loan Status Influence Estimated Return
  ggplot(aes(x = LoanStatus,y = EstimatedReturn),data = pd) + geom_boxplot() +
  theme(axis.text.x =   element_text(angle = 45,size = 20))
  # We expect the Estimated Return to be correlated with the Lender Yield. How does the
  # Prosper Rating affect this relationship?
  ggplot(aes(x = LenderYield,y = EstimatedReturn,color = ProsperRating..numeric.),data = pd) +
  geom_point()+guides(color = guide_legend(title = "Rating", override.aes = list(alpha = 1,size = 5)))
  #Notice that PrsperScore Offers better resolution to distinguish the bands with the
  # lowest Estimated Returns
  ggplot(data = pd,aes(x = LenderYield,y = EstimatedReturn,color = ProsperScore)) +
  geom_point()+guides(color = guide_legend(title = "Score", override.aes = list(alpha = 1,size = 5)))
  ### Instead of Prosper rating, using ProsperScore gives better distinction
  
  ggplot(aes(x = EstimatedEffectiveYield,y = EstimatedReturn),data = pd) +
  geom_point(color = 'purple') + 
    guides(color = guide_legend(title = "Rating", override.aes = list(alpha = 1,size = 5)))
  # Loan Terms are 12, 36 and  60 months; separating by Loan Term
  # Term == 12 or 60
  ggplot(aes(x = EstimatedEffectiveYield,y = EstimatedReturn),data = pd[pd$Term !=36,]) +
  geom_point(color = 'blue') 
  # Term == 36
  ggplot(aes(x = EstimatedEffectiveYield,y = EstimatedReturn),data = pd[pd$Term ==
  36,]) +
  geom_point(color = 'red') 
  # There seem to be two regimes within the 36month Term itself.
  # Term ==36 and LoanMonthsSinceOrigination >= 40
  # In this case we see that return = Effective yield (no difference)
  # implying that estimated loss rate = 0.
  ggplot(aes(x = EstimatedEffectiveYield,y = EstimatedReturn),data = pd[pd$Term ==
  36 & pd$LoanMonthsSinceOrigination >= 39,]) +
  geom_point(color = 'red')
  # Term ==36 and LoanMonthsSinceOrigination < 39
  # There are cases where it is within 39 months of the loan's beginning data
  # i.e. no later than 3 months after loan term
  ggplot(aes(x = EstimatedEffectiveYield,y = EstimatedReturn),data = pd[pd$Term == 36 & 
                                                    pd$LoanMonthsSinceOrigination < 39,]) +
  geom_point(color = 'red') + guides(color = guide_legend(title = "Rating", override.aes =
  list(alpha = 1,size = 5)))
  
  #
  ggplot(data = pd[pd$Term == 36 & pd$LoanMonthsSinceOrigination < 39,]) + 
  geom_point(aes(x = EstimatedEffectiveYield,y = EstimatedReturn,color = ProsperScore)) +
  stat_smooth(aes(x = EstimatedEffectiveYield,y = EstimatedReturn),method = "lm", 
              formula = y ~ poly(x,1), size = 1) +
  guides(color = guide_legend(title = "Score", override.aes = list(alpha =
  1,size = 5)))
  
  ######
  # We try another way to split the data, by classifying them as a loan that is on-going (more
  # payments are expected in the future) or a loan that is done (no more payments expected).
  #
  
  levels(pd$LoanStatus) # The different levels that a loanStatus is in.
  unique(pd$LoanStatus)
  pd$LoanStatusBucket = mapvalues(pd$LoanStatus, from = levels(pd$LoanStatus), to = c(
    "Done","OnGoing","OnGoing","OnGoing","OnGoing","OnGoing","OnGoing",
    "OnGoing","OnGoing","Done","Done","Done" ))
  
  #"Current","FinalPaymentInProgress","Completed","Past Due (1-15 days)","Past Due (16-30 days)", "Past Due (31-60 days)", "Past Due (61-90 days)", "Past Due (91-120 days)", "Past Due (>120 days)","Defaulted","Chargedoff","Cancelled"
  
  ggplot(data = pd[pd$Term == 36,]) +
  geom_point(aes(x = BorrowerRate,y = EstimatedLoss,color = LoanStatusBucket)) +
  guides(color = guide_legend(title = "Status", override.aes = list(alpha =1,size = 5)))
  # Here it might seem that the linear relationship between the variables is when the status
  # is ongoing; else it seems like there is a wider spread of borrower rate for a given
  # EstimatedLoss
  ggplot(data = pd[pd$Term == 36 &
  pd$LoanStatusBucket == "Done",]) +
  geom_point(aes(x = BorrowerRate,y = EstimatedLoss,color = LoanStatusBucket)) +
  guides(color = guide_legend(title = "Status", override.aes = list(alpha = 1,size = 5)))
  # We see that this kind of splitting does not clearly demarcate the linear and spreadout
  # regimes. This indicates that there must be some other criterion splitting the data in to the 
  # two regimes.

 ###### By ProsperScore
  # Define a function to compute stats
  stat_sum_single <- function(fun, geom = "point", ...) {
  stat_summary(
  fun.y = fun, colour = "black", geom = geom, size = 1, ...
  )
  }
  
  p1 <-
  ggplot(data = pd[pd$Term == 36 &
  pd$LoanMonthsSinceOrigination < 39 & !is.na(pd$EstimatedEffectiveYield) ,],aes(x =
                                           EstimatedLoss,y = EstimatedEffectiveYield)) +
  stat_sum_single(mean,geom = "line",linetype=2) +
  stat_smooth(method = "lm", formula = y ~ poly(x,1), size = 1) +
  geom_point(aes(color = ProsperScore),alpha = 1 / 2) +
  guides(color = guide_legend(override.aes = list(alpha = 1,size = 5)))
  print(p1)
  
  pd$Term = as.factor(pd$Term)
  npd <- pd[!is.na(pd$EstimatedEffectiveYield) &
              pd$EstimatedEffectiveYield <0.275 & pd$LoanMonthsSinceOrigination >= 39 
            & pd$Term == 36,]
  
  p2 <-   ggplot(data = npd,
  aes(x = EstimatedLoss,y = EstimatedEffectiveYield,color = ProsperScore,group=1)) +
  geom_point(alpha = 1 / 2,size = 3)+
  stat_smooth(method = "lm", formula = y ~ poly(x,2)) +
  stat_sum_single(mean,geom = "line") +
  guides(color = guide_legend(override.aes = list(alpha = 1,size = 5))) 
  print(p2) 
  
  p3 <- ggplot(data = pd[!is.na(pd$EstimatedEffectiveYield) & 
  pd$LoanMonthsSinceOrigination < 39,],aes(x = EstimatedLoss,y = EstimatedEffectiveYield,shape=
  Term))+
  stat_smooth(method = "lm", formula = y ~ poly(x,1), size = 1,aes(color = Term)) +
  guides(color = guide_legend(override.aes = list(alpha = 1,size = 8))) +ylab("Eff. Loss")
  p4 <-   p3 + geom_point(aes(x = EstimatedLoss,y = EstimatedEffectiveYield,shape = Term),alpha =
  1 / 10, size = 3  ) + guides(shape = guide_legend(override.aes = list(alpha = 1,size = 4)))+ylab("Eff. Yield")
  print(p4)
  
```
Notice that the Estimated effective yield for the lender is minimum when the Loan Status is completed. That means that the Lender Stands to gain least if the lender pays off his loan in a timely manner. Discounting the cases where loans are charged-off, it seems that the Lender can maximize profits by charges levied on the borrower (interest and late fees).

## Debt To Income Ratio
```{r}
#Reconvert EstimateLoss to a numeric type to allow math operations.
pd$EstimatedLoss = as.numeric(pd$EstimatedLoss)
pDtoIR<- ggplot(aes(y = DebtToIncomeRatio,x = BorrowerRate),data =
           pd[pd$Term == 36 & pd$DebtToIncomeRatio > 0 ,])+
        geom_point(aes(color = ConsolCreditGrade),position = position_jitter(width = 0.005,
                       height = 0.05),alpha=1/3) +scale_color_brewer(palette="Set1")+
        scale_y_log10(limits=c(0.005,10^0.4))+
        xlim(c(0,0.4))+
        stat_smooth(method = "lm", formula = y ~ poly(x,1),se=TRUE,size=1)+
        guides(color = guide_legend(title = "Grade", override.aes = list(alpha = 1,size = 5)))
print(pDtoIR)
```
```{r YieldByScore}
ggplot(aes(factor(ProsperScore),LenderYield),data=pds)+geom_boxplot()

```

## Credit Score
```{r CreditScore}
ggplot(aes(x=CreditScoreRangeLower),data=pd,binwidth=5)+geom_histogram()
```
```{r CreditScore1}
ggplot(aes(y=EstimatedLoss,x=BorrowerRate,color=CreditScoreRangeLower),
       data=pd[pd$CreditScoreRangeLower>320,])+geom_point(alpha=1/2,size=3)+
scale_color_gradientn(colours = rainbow(10))+
guides(color=guide_colorbar(title="Cred Score", override.aes =list(alpha=1)))
```
```{r CreditScore2}
# Only the 36 month loans
ggplot(aes(y=EstimatedLoss,x=BorrowerRate,color=CreditScoreRangeLower),
       data=pd[pd$Term==36 & pd$CreditScoreRangeLower>320 & pd$LoanMonthsSinceOrigination >39,])+
geom_point(alpha=1/3,size=3)+
scale_color_gradientn(colours = rainbow(10))+
guides(color=guide_colorbar(title="Cred Score", override.aes =list(alpha=1)))
```
## Term + Loan Status
```{r CreditScore3}
# Only the 12 and 60 month loans
library('gridExtra')
p1<-ggplot(aes(y=EstimatedLoss,x=BorrowerRate),data=pd[pd$CreditScoreRangeLower>320 &
                                                         pd$Term==12,])+
  geom_point(aes(color=CreditScoreRangeLower),alpha=1/3,size=3)+
geom_smooth(method="lm")+scale_color_gradientn(colours = rainbow(10))+
ggtitle("Term=12 Months")+
guides(color=guide_colorbar(title="Cred Score", override.aes =list(alpha=1)))

p2 <- ggplot(aes(y=EstimatedLoss,x=BorrowerRate),data=pd[pd$Term==60,])+
geom_point(aes(color=CreditScoreRangeLower),alpha=1/3,size=3)+
scale_color_gradientn(colours= rainbow(10))+
geom_smooth(method="lm")+ggtitle("Term =60 Months")+
guides(color=guide_colorbar(title="Cred Score", override.aes =list(alpha=1)))

p3 <- ggplot(aes(y=EstimatedLoss,x=BorrowerRate),data=pd[pd$Term==36
                                                 &pd$LoanMonthsSinceOrigination <39 ,])+
geom_point(aes(color=CreditScoreRangeLower),alpha=1/3,size=3)+
scale_color_gradientn(colours= rainbow(10))+
geom_smooth(method="lm")+ggtitle("Term =36 Months (Loan Month <39)")+
guides(color=guide_colorbar(title="Cred Score", override.aes =list(alpha=1)))

grid.arrange(p1,p3,p2,ncol=1)
```
```{r Term}
# All three time TERM periods (12, 36 and 60 months)
ggplot(aes(y=EstimatedLoss,x=BorrowerRate,color=Term),data=pd)+geom_point(alpha=1/5,size=3)+
scale_color_brewer(palette = 'Set1',guide = guide_legend(title = 'Term', 
                    reverse = T,override.aes = list(alpha = 1, size = 5)))
```
## By CreditScore
```{r CreditScore4}
pd$EstimatedLoss = as.numeric(pd$EstimatedLoss)
ggplot(aes(y=EstimatedLoss,x=LoanStatus,color=CreditScoreRangeLower),
       data=pd[pd$CreditScoreRangeLower>400,])+
geom_point(alpha=1/5,size=3)+scale_y_log10()+
geom_boxplot(outlier.size = .1,alpha=1/20)+
theme(axis.text.x  = element_text(angle=45, vjust=1.0, size=15))+
guides(color=guide_colorbar(title="Cred Score", override.aes =list(alpha=1)))+
scale_color_gradientn(colours=rainbow(10))
```

## Credit Lines
```{r bucket}
pd$CreditLines.bucket <- cut(pd$CurrentCreditLines, breaks =c(0,seq(1,25,5),60))

ggplot(aes(y=EstimatedLoss,x=LoanStatus,color=CreditLines.bucket),data=
                                  pd[!is.na(pd$EstimatedLoss) & !is.na(pd$CreditLines.bucket),])+
      scale_color_brewer(type='div',palette = 'Set1',guide = 
                                              guide_legend(override.aes = list(alpha=1,size=1)))+
      geom_boxplot(outlier.size = .5)+ylim(0,.25)+
      theme(axis.text.x  = element_text(angle=45, vjust=0.8, size=18))+
      guides(color=guide_legend(title="Cred Lines", override.aes =list(alpha=1)))

p0<-ggplot(aes(y=EstimatedReturn,x=LoanStatus,color=CreditLines.bucket),data=
                                  pd[!is.na(pd$EstimatedLoss) & !is.na(pd$CreditLines.bucket),])
p1 <- p0+ scale_color_brewer(type='div',palette = 'Set1',guide = 
                               guide_legend(override.aes = list(alpha=1,size=1)))+
      geom_boxplot(outlier.size = .5)+ylim(0,.25)+
      theme(axis.text.x  = element_text(angle=45, vjust=0.8, size=18))+
      guides(color=guide_legend(title="Cred Lines", override.aes =list(alpha=1)))
print(p1)

pd$ReturnCut <- cut(pd$EstimatedReturn, breaks =c(-0.2,-1e-9,seq(0,0.3,0.01)))
ggplot(aes(x=CurrentCreditLines),data=pd[!is.na(pd$ReturnCut) & !is.na(pd$CurrentCreditLines),])+ geom_histogram(binwidth=1,aes(fill=ReturnCut,y=..count..))+scale_x_discrete()+theme(axis.text.x=element_text(size=15))+guides(fill=guide_legend(title="Returns"))
```

## Customer Payments
```{r}
 ggplot(aes(y=LP_CustomerPayments,x=LoanOriginalAmount),data=
          pd[pd$LP_CustomerPayments>1,],binwidth=.01)+
  geom_point(alpha=1/10)+ylab('Customer Payments')+
  xlab('Loan Original Amount')

```
Clearly there is an upper-bound of the Gross Principal Loss which is equal to the Loan Original Amount (one cannot lose more than the amount loaned). This indicates that in some cases the entire loan was a loss for the lender. A majority of the loans have zero Principal Loss, indicating that most of the loan is recovered. A similar plot is obtained when comparing the Net Principal Loss. 

## Estimated Loss
```{r Loss_By_CreditGrade}
ggplot(aes(y=LP_NetPrincipalLoss/LoanOriginalAmount,x=CreditGrade),data=pd[pd$LP_NetPrincipalLoss>0,],binwidth=.01)+
geom_boxplot()+ylab('Net Prin. Loss/ Loan Orig. Amt')
  
```
The percentage of loaners in each category that are ``lossy'' for the lender increases as the credit grade worsens. The mean loss also increases. In fact for groups other than "AA" and 'A' grades sometimes the the 

## Equations
I introduce a few notations to make it slightly easier to understand the relationship between the different variables based on their description:
\begin{quote}
$y_e$ = Effective Yield\\
$y_l$ = Lender Yield\\
$r$ = Returns \\
$I$ = Borrower Interest Rate \\
$f_s$ = Service Fees \\
$f_l$ = Late Fees \\ 
$u$ = uncollected interest on charge-offs \\
$l$ = Loss
\end{quote}

\begin{align}
y_e &= I +f_l-f_s-u \\
r &= y_e - l \\
y_l &= I-f_s \\
\Rightarrow y_e &= y_l+f_l-u \\
r &=y_l+f_l-l-u
\end{align}

## Final Plots and Summary
### Returns By ProsperScore (and By Term) 

In this plot we look at the Estiamted Return for loans and analyze them based on Terms and colored by the ProsperScore. We find that in all plots  there is a trend of decreasing returns with decreasing (i.e. better) ProsperScore. As a borrower this means that if one is looking to get a loan with the lowest interest rate, it is essential to have established really good credit worthiness. We see that, in reality, very few borrowes are able to maintain a pristine score. The vast majority of the lenders have a score of 8 or below. We would imagine that increasing risk of lending to borrowers with worse scores would prevent lending. However we see that even borrowers with a Score of 1 are able to secure loans. Not only that, the lender is also able to extract a higher return from these groups probably in the form of late fee and interest. Conversely if the return is low on better scores what could be the incentive to give out loans to such a group? As we will see in the following plot, such a group also minimizes loss and hence is less risky from the lender's perspective. 

The 36 month long loans for which borrowers have taken more than 90 days since the loan period expires (i.e. LoanMonthsSinceOrigination >39), some loans show negative returns. For all other categories the lender always has positive returns on the loans made. We also note that in this category, the number of borrowers with better scores increases dramatically over the other sections. Also the highest ProsperScore of 11 is not given to any borrower who has not repaid the loan within the term period. 

### Returns By LoanStatus / Yield vs Loss
```{r finalplots,echo=FALSE}

p1 <- ggplot(aes(x=EstimatedReturn,fill=ProsperScore),data=pd[pd$Term==60,])+
  geom_histogram(binwidth=0.003)+scale_x_continuous(breaks=seq(-0.2,0.3,0.02))+
  theme(axis.text.x  = element_text(angle=0, size=15))+ggtitle('Term = 12 Months')+
  guides(fill=guide_legend(title="Score"))+
  xlab("Return")

p2<-ggplot(aes(x=EstimatedReturn,fill=ProsperScore),data=pd[pd$Term==12,])+
  geom_histogram(binwidth=0.003)+scale_x_continuous(breaks=seq(-0.2,0.3,0.02))+
  theme(axis.text.x  = element_text(angle=0, size=15))+ggtitle('Term = 60 Months')+
  guides(fill=guide_legend(title="Score"))+
  xlab("Return")

p3<-ggplot(aes(x=EstimatedReturn,fill=ProsperScore),data=pd[pd$Term==36 & pd$LoanMonthsSinceOrigination <39,])+
  geom_histogram(binwidth=0.003)+scale_x_continuous(breaks=seq(-0.2,0.3,0.02))+
  theme(axis.text.x  = element_text(angle=0, size=15))+ggtitle('Term = 36 Months')+
  guides(fill=guide_legend(title="Score"))+
  xlab("Return (Months Since Origin <39)")

p4<-ggplot(aes(x=EstimatedReturn,fill=ProsperScore),data=pd[pd$Term==36 & pd$LoanMonthsSinceOrigination >=39,])+
  geom_histogram(binwidth=0.005)+scale_x_continuous(breaks=seq(-0.2,0.3,0.04))+
  theme(axis.text.x  = element_text(angle=0, size=15))+ggtitle('Term = 36 Months')+
  guides(fill=guide_legend(title="Score"))+
  xlab("Return (Months Since Origin >=39)")
grid.arrange(p1,p2,p3,p4,ncol=2)
```

```{r, echo=FALSE}
npd <- pd[pd$EstimatedReturn>1e-5 & !is.na(pd$EstimatedReturn),]
npd$ReturnCut <- cut(npd$EstimatedReturn,c(seq(0,0.3,0.02)))
p0<- ggplot(aes(x=CurrentCreditLines),data=npd[!is.na(npd$ReturnCut) & !is.na(npd$CurrentCreditLines),])+ geom_histogram(binwidth=1,aes(fill=ReturnCut))+scale_x_discrete()+theme(axis.text.x=element_text(size=15))+guides(fill=guide_legend(title="Returns"))+theme(axis.text.x =element_text(size=10),legend.title=element_text(size=10))

library(dplyr)
spd <- pd[!is.na(pd$EstimatedReturn) & !is.na(pd$CurrentCreditLines),] %>%
      group_by(CurrentCreditLines) %>%
      dplyr::summarise(mean_Return = mean(EstimatedReturn))%>%
      arrange(CurrentCreditLines)

p1<-ggplot(aes(x=CurrentCreditLines,y=mean_Return),data=spd)+
  geom_bar(stat="identity",aes(alph=0.2),color="blue")+
  scale_x_discrete(breaks=seq(0,60,1))+
  theme(axis.text.x =element_text(angle=0,size=10))+
  ylab("Mean Return")+xlab("No: Of Credit Lines")

pd$CreditLines.bucket <- cut(pd$CurrentCreditLines, breaks =c(0,seq(1,25,5),60))

p2<-ggplot(aes(y=EstimatedReturn,x=LoanStatus,color=CreditLines.bucket),data=
             pd[!is.na(pd$EstimatedLoss) & !is.na(pd$CreditLines.bucket),])+
  scale_color_brewer(type='div',palette = 'Set1',guide = 
                       guide_legend(override.aes = list(alpha=1,size=1)))+
  geom_boxplot(outlier.size = .5)+ylim(0,.25)+
  theme(axis.text.x  = element_text(angle=45, vjust=0.8, size=10))+
  guides(color=guide_legend(title="Cred Lines", override.aes =list(alpha=1)))

p3<-ggplot(aes(x=EstimatedLoss,y=EstimatedEffectiveYield),data=
             pd[pd$Term!=36 | pd$LoanMonthsSinceOrigination<39,])+
  geom_point(aes(color=ProsperScore))+
  guides(color=guide_legend(title="P.Score", override.aes =list(size=5)))+
  ylab("Eff. Yield")

p4<-ggplot(aes(x=EstimatedLoss,y=EstimatedEffectiveYield),data=
             pd[pd$Term==36 & pd$LoanMonthsSinceOrigination>39,])+
  geom_point(aes(color=ProsperScore))+guides(color=guide_legend(title="P.Score", 
                                                                override.aes =list(size=5)))+
  ylab("Eff. Yield")

grid.arrange(p0,p2,p1,arrangeGrob(p3,p4,ncol=1),ncol=2)
```
In this figure we try to see if the number of credit lines a borrower has, has any effect on the returns the lender gets. From the histogram it is hard to tell because each credit line seems to have borrowers yielding returns at all levels (all colors). By considering the mean returns we see that there is in fact a reduction of returns based on the number of credit lines. Mean returns decrease from 0 to 7 credit lines and there after remains more or less constant till about 30 lines and then shows fluctuations. However by slicing the data based on the status of the loan we can see that the mean returns does indeed decrease based on the number of credit lines. Discounting Chargedoff loans all other categories show that there is considerable decrease in the mean returns beyond the 5 credit line bucket. 

Since the Returns is linearly related to Loss and Yield (see above equation), we plot the Yield vs Loss to assess if the lower returns (for better Prosper Scores) are as a result of greater loss or lower yields or both. We notice that, surprisingly, the Yield and Loss are related in an almost linear fashion and this holds for all ProsperScore groups. This linear trend is violated only for loans with 36 month Term that have passed the 90 limit since ending the Term limit (i.e. 39 months after Term origination). 

### Trends In The Variables
```{r, Trends,echo=FALSE}
p1<-ggplot(aes(x=ProsperScore,y=EstimatedEffectiveYield),data=pd)+
    geom_boxplot(outlier.size = 1,alpha=1/20)+
    stat_smooth(method = "lm", formula = y ~ poly(x,1), size = 1,aes(group=1))+
    xlab("")+ylab("Eff. Yield")
p2 <- ggplot(aes(x=ProsperScore,y=BorrowerAPR),data=pd)+
    geom_boxplot(outlier.size = 1,alpha=1/20)+
    stat_smooth(method = "lm", formula = y ~ poly(x,1), size = 1,aes(group=1))+ylab("Bo. APR")
g<- arrangeGrob(p1,p2,ncol=1)

pY<-ggplot(data = pd[pd$LoanMonthsSinceOrigination < 39,],aes(x = EstimatedLoss,y =
                                                          EstimatedEffectiveYield,color= Term))+
    stat_smooth(method = "lm", formula = y ~ poly(x,1), size = 1,aes(color = Term)) +
    geom_point(aes(x = EstimatedLoss,y = EstimatedEffectiveYield,color= Term))+
    ylab("Eff. Yield")+
    guides(color = guide_legend(override.aes = list(alpha = 1,size = 8))) 
  
pB<-ggplot(data = pd[pd$LoanMonthsSinceOrigination < 39,],aes(x = EstimatedLoss,y =  
                                                                EstimatedEffectiveYield))+
  geom_point(aes(x = EstimatedLoss,y = EstimatedEffectiveYield,color=BorrowerAPR),size=2)+
  scale_color_gradientn(colours = rainbow(10))+
  ylab("Eff. Yield")+
  guides(color = guide_colorbar(title="APR",override.aes = list(alpha = 1,size = 8)))

g1<- arrangeGrob(pY,pB,ncol=1)
grid.arrange(g,g1,pamtDelinq,pDtoIR,ncol=2)

```

Here we explore some of the linear trends in the data that might not be obvious at first sight. EstimatedYield and EstimatedLoss both show a linear decrease with improving ProsperScore. We see that all the three Loan Terms show that this linear trend holds. However, even within a Term period, for example the 60 month loans, we see that for the same Loss there are multiple values of returns. This could be because of the difference in  Interest rate, late fess, Service Fees or uncollected interest on charge-offs. To establish this we see that when colored by the APR the returns increase as the APR increases for a given EstimatedLoss. Thus the trend of increasing return with Borrower APR holds good for each value of Estimated Loss.  Also we see that there are trends in the DebtToIncomeRatio (based on creditRating) and the AmountDelinquent based on the number of delinquencies the borrower has had in the past 7 years.

### Summary
\begin{itemize}
\item The discovered trends seem to reflect intuitive thinking that as the credit worthiness of the borrower improves (ProsperScore, CreditScore, CreditRating) the BorrowerRate also goes down.
\item Both Yield and Loss (for the lender) also decrease linearly with improving credit rating. 
\item The lender gets greater returns by lending to borrowers with mediocre and poor credit ratings (compared to people with excellent ratings) and recouping more money than is actually lent in the form of interest and fees.
\item For a given loan status the number of creditlines a borrower seem to affect the returns yielded: the lesser the credit lines, higher the returns. When the returns are not split along loan status, this reduction of returns with increasing credit line is observed only up 7 lines of credit and then the return are more or less constant.
\item The mean amount delinquent (log) on a loan is related to the number of delinquencies (log) in the last 7 years. The relationship is linear on the log-log scale. 
\item Th mean DebtToIncomeRatio (log) shows a linear relationship with to the BorrowerRate. In other words, the BorrowerRate levied on a borrower is affected by the DebtToIncomeRatio of the borrower.
\item The EstimatedLoss increases with worsening credit rating.
\item The EstimatedLoss for each LoanStatus increases as the credit score/rating lowers. 
\item Yield and Loss are linearly related and implies that returns and loss will also be linearly related.
\item Most of the loans have a constant service fee of 0.01%.
\item California takes the most loans and Wyoming has the least.
\end{itemize}

## Reflection:
Many pieces of information together to get an idea of trends in the data and to understand some of the features playing an important role in shaping these trends.
One aim to undertaking such an exploratory analysis of the data would be to build models that can help decide the BorrowerAPR and other terms of a loan when a new Borrower applies for a loan, given his current "feature" values. By knowing which variable have a discernible effect on the outcome, it becomes easier to make a more accurate model. As a Borrower it is useful to understand what features are most valued by the Lender so that he can position himself better to get a better rate on the loan. 

The lack of a clear objective when I got the data was an impediment. Matrixplots were too dense to make sense at first and required breaking them up.  In the above analysis some conflict between dplyr and plyr (specifically the order in which they are loaded) caused some errors in compiling the KnitPDF document to be submitted. While it seemed that the linear zones in the data (Fig. 25) was based on Loan Status, it revealed that only part of the data (Fig. 26) could be explained by that kind of splitting along LoanStatus (Done vs On-Going).

I went through the list of variables and their description in the excel sheet and selected variables that seemed to affect the loan data and narrow down the list of relevant variables. It would be great if the variables could be broken to k-buckets and the ggpairs package could generate $k^2$ subplots to look at the dependance of the variables (k=2 or 3 at most). I tried to break the matrix plot in to subplots and catch any interesting correlations in the subplots.  

Another problem was applying varying color (i.e. colorbar instead of legend) to each bar in a histogram. It was impossible to apply a varying color (like coloring the histogram of returns by credit score). While aes(color=as.factor(CreditScoreRangeLower)) achieves the result it could not provide a good legend. This was solved by breaking the continuous variable in to buckets and coloring by buckets. 

Writing the relationship between some of the crucial variables made it slightly easier to see which variables to focus on: for example, knowing that Returns and Yield were linearly related made it obvious that they would be correlated. However, knowing that Yiled and Loss have no explicit relation between them and are seemingly unrelated made the finding of linearity in the Yield vs Loss plot very interesting.

Dilineating data based on Term was important to get the linear zones in many of the plots demarcated. However for Term ==36, the linear zones was not easy to demarcate. A further splitting along 'LoanMonthsSinceOrigination' deamarcated the linear and nonlinear zones of 36 month loans. Through trial and error it was found that LoanMonthsSinceOrigination ==39 was a crucial threshold that separated to regimes in the daa. The 36 month loan which had LoanMonthsSinceOrigination >=39 was the only regime  where the Lender had negative returns. 


